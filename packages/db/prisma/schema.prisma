generator client {
  provider = "prisma-client-js"
  output   = "../../../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum SiteKind {
  shelter
  space
  other
}

enum HazardType {
  earthquake
  tsunami
  flood
  inland_flood
  typhoon
  landslide
  fire
  volcano
  storm_surge
}

enum CongestionLevel {
  low
  normal
  high
}

enum AccessibilityLevel {
  accessible
  blocked
  unknown
}

enum SafetyState {
  safe
  minor_injury
  serious_injury
  isolated
  evacuating
  evacuated
}

model EvacSite {
  id                 String                      @id @default(uuid()) @db.Uuid
  kind               SiteKind
  sourceId           String?
  name               String
  address            String?
  latitude           Float
  longitude          Float
  municipalityCode   String?
  capacity           Int?
  isDesignated       Boolean                     @default(true)
  sourceName         String
  sourceUrl          String?
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  hazardCapabilities EvacSiteHazardCapability[]
  statusReports      SiteStatusReport[]
  safetyStatuses     SafetyStatus[]              @relation("SiteSafetyStatus")

  @@unique([sourceId])
  @@index([latitude, longitude])
  @@index([municipalityCode])
}

model EvacSiteHazardCapability {
  id          String      @id @default(uuid()) @db.Uuid
  site        EvacSite    @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId      String      @db.Uuid
  hazardType  HazardType
  isSupported Boolean     @default(false)
  remark      String?

  @@unique([siteId, hazardType])
  @@index([hazardType])
}

model SiteStatusReport {
  id               String             @id @default(uuid()) @db.Uuid
  site             EvacSite           @relation(fields: [siteId], references: [id], onDelete: Cascade)
  siteId           String             @db.Uuid
  deviceHash       String
  device           Device?            @relation("DeviceReports", fields: [deviceId], references: [id], onDelete: SetNull)
  deviceId         String?            @db.Uuid
  congestionLevel  CongestionLevel
  accessibility    AccessibilityLevel
  comment          String?
  reportedAt       DateTime           @default(now())

  @@index([siteId, reportedAt])
  @@index([deviceHash, reportedAt])
  @@index([deviceId])
}

model Device {
  id            String          @id @default(uuid()) @db.Uuid
  deviceHash    String          @unique
  transferCode  String          @unique
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  safetyStatus  SafetyStatus?
  watchRegions  WatchRegion[]
  statusReports SiteStatusReport[] @relation("DeviceReports")
}

model SafetyStatus {
  id             String       @id @default(uuid()) @db.Uuid
  device         Device       @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  deviceId       String       @unique @db.Uuid
  status         SafetyState
  currentSite    EvacSite?    @relation("SiteSafetyStatus", fields: [currentSiteId], references: [id])
  currentSiteId  String?      @db.Uuid
  updatedAt      DateTime     @default(now())
}

model WatchRegion {
  id          String                   @id @default(uuid()) @db.Uuid
  device      Device                   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  deviceId    String                   @db.Uuid
  label       String
  latitude    Float
  longitude   Float
  radiusKm    Float
  active      Boolean                  @default(true)
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  hazards     WatchRegionHazard[]

  @@index([deviceId])
}

model WatchRegionHazard {
  id         String      @id @default(uuid()) @db.Uuid
  region     WatchRegion @relation(fields: [regionId], references: [id], onDelete: Cascade)
  regionId   String      @db.Uuid
  hazardType HazardType
  active     Boolean     @default(true)

  @@unique([regionId, hazardType])
}

model HazardAlertSnapshot {
  id         String      @id @default(uuid()) @db.Uuid
  region     WatchRegion @relation(fields: [regionId], references: [id], onDelete: Cascade)
  regionId   String      @db.Uuid
  hazardType HazardType
  riskLevel  String
  checkedAt  DateTime    @default(now())

  @@index([regionId, hazardType, checkedAt])
}
